<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        /* 基本のスタイル設定 */
        :root {
            --bg-color: #f9f9f9; --text-color: #333; --card-bg-color: #fff;
            --border-color: #ddd; --link-color: #007bff; --secondary-text-color: #888;
            --shadow-color: rgba(0,0,0,0.1);
        }
        /* ダークモード用のスタイル */
        body.dark-mode {
            --bg-color: #1a1a1a; --text-color: #e0e0e0; --card-bg-color: #2c2c2c;
            --border-color: #444; --link-color: #58a6ff; --secondary-text-color: #aaa;
            --shadow-color: rgba(0,0,0,0.4);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 2em; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        h1 { text-align: center; color: var(--text-color); }
        .header-container { text-align: center; margin-bottom: 2em; }
        .header-container a { margin: 0 10px; color: var(--link-color); text-decoration: none; }
        #theme-toggle-btn { background: none; border: 1px solid var(--border-color); color: var(--text-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .post-form { max-width: 600px; margin: 0 auto 2em auto; background: var(--card-bg-color); padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px var(--shadow-color); }
        .post-form label { display: block; margin-bottom: 0.5em; font-weight: bold; }
        .post-form input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--bg-color); color: var(--text-color); font-size: 16px; }
        .post-form input[type="submit"], .post-form button { padding: 10px 15px; border: none; background-color: var(--link-color); color: white; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .post-form button { background-color: #6c757d; }
        #reply_info { font-size: 0.9em; color: var(--secondary-text-color); margin-top: 10px; }
        .timeline { max-width: 600px; margin: 0 auto; }
        #filter-info { text-align: center; margin-bottom: 1em; }
        #clear-filter-btn { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .note { background: var(--card-bg-color); border: 1px solid var(--border-color); padding: 1em; border-radius: 8px; margin-bottom: 1em; box-shadow: 0 1px 3px var(--shadow-color); }
        .note .time { font-size: 0.8em; color: var(--secondary-text-color); margin-bottom: 0.5em; }
        .note .reply a { color: var(--link-color); text-decoration: none; font-size: 0.9em; }
        .note-content p { margin: 0.5em 0; white-space: pre-wrap; word-wrap: break-word; }
        .note-content a.tag { color: var(--link-color); font-weight: bold; text-decoration: none; }
        .renote blockquote { border-left: 3px solid #eee; padding-left: 1em; margin: 0.5em 0; color: #555; white-space: pre-wrap; word-wrap: break-word; }
        .renote-label { font-weight: bold; color: #555; font-size: 0.9em; }
        .icon-btn { margin-right: 10px; color: var(--secondary-text-color); text-decoration: none; }
        .delete-btn { color: #dc3545; }
    </style>
</head>
<body>
    <h1>神の罪の交流</h1>
    <div class="header-container">
        <button id="theme-toggle-btn"><i class="fa-solid fa-moon"></i></button>
    </div>
    <form class="post-form" id="post-form">
        <label>投稿 ( #タグ が使えます)</label>
        <input type="text" name="note" required>
        <input type="hidden" name="reply_to" id="reply_to_input" value="">
        <div id="reply_info"></div>
        <button type="button" id="cancel_reply" style="display:none;">返信をキャンセル</button>
        <input type="submit" value="投稿">
    </form>
    <div id="filter-info"></div>
    <div class="timeline" id="timeline"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM要素の取得 ---
        const postForm = document.getElementById('post-form');
        const timeline = document.getElementById('timeline');
        const replyToInput = document.getElementById('reply_to_input');
        const replyInfo = document.getElementById('reply_info');
        const cancelReplyBtn = document.getElementById('cancel_reply');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const filterInfo = document.getElementById('filter-info');

        // --- データ管理 (ローカルストレージ) ---
        const notesDB = {
            get: () => JSON.parse(localStorage.getItem('notes') || '[]'),
            save: (notes) => localStorage.setItem('notes', JSON.stringify(notes)),
        };

        // --- テーマ管理 ---
        const theme = {
            get: () => localStorage.getItem('theme') || 'light',
            set: (themeName) => {
                localStorage.setItem('theme', themeName);
                document.body.className = themeName === 'dark' ? 'dark-mode' : '';
                themeToggleBtn.innerHTML = themeName === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
            }
        };

        // --- ヘルパー関数 ---
        const toJST = (isoString) => new Date(isoString).toLocaleString('ja-JP');
        
        // XSS対策：HTML特殊文字をエスケープする関数
        const escapeHTML = (str) => {
            if (!str) return '';
            return str.replace(/[&<>"']/g, (match) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[match]));
        };

        // タグ(#タグ)をリンクに変換する関数
        const linkifyTags = (text) => {
            const escapedText = escapeHTML(text);
            return escapedText.replace(/#([a-zA-Z0-9ぁ-んァ-ヶー一-龠_]+)/g, '<a href="#" class="tag" data-tag="$1">#$1</a>');
        };

        // --- タイムライン描画 ---
        const renderTimeline = (tagFilter = null) => {
            let allNotes = notesDB.get();
            
            // タグによるフィルタリング
            if (tagFilter) {
                allNotes = allNotes.filter(note => note.post && note.post.includes(`#${tagFilter}`));
                filterInfo.innerHTML = `#${escapeHTML(tagFilter)} でフィルタ中 <button id="clear-filter-btn">解除</button>`;
                document.getElementById('clear-filter-btn').onclick = () => renderTimeline();
            } else {
                filterInfo.innerHTML = '';
            }

            // 投稿を新しい順にソート
            allNotes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const parentMap = new Map(allNotes.map(note => [note.id, note]));

            if (allNotes.length === 0) {
                timeline.innerHTML = '<div class="not_note" style="text-align: center; color: var(--secondary-text-color);"><p>まだ投稿がありません。</p></div>';
                return;
            }

            // タイムラインのHTMLを生成
            timeline.innerHTML = allNotes.map(note => {
                const parent = note.reply_to ? parentMap.get(note.reply_to) : null;
                const original = note.renote_from_id ? parentMap.get(note.renote_from_id) : null;
                
                const safePost = linkifyTags(note.post);
                const safeParentPost = escapeHTML(parent?.post);
                const safeOriginalPost = linkifyTags(original?.post);

                return `
                <div id="note-${note.id}" class="note" data-post-id="${note.id}">
                    <div class="time"><small>(${toJST(note.created_at)})</small></div>
                    ${note.reply_to && parent ? `<div class="reply">返信元:<a href="#note-${parent.id}">${safeParentPost}</a></div>` : ''}
                    <div class="note-content">
                        ${note.renote_from_id ? `
                            <div class="renote">
                                ${original ? `<p class="renote-label">リノートしました</p><blockquote>${safeOriginalPost}</blockquote>` : `<p>リノート元は削除されています</p>`}
                            </div>
                        ` : `<p>${safePost || ''}</p>`}
                    </div>
                    <div class="actions">
                        ${note.post && !note.renote_from_id ? `
                            <a href="#" class="reply-btn icon-btn" data-reply-to="${note.id}" title="返信"><i class="fa-solid fa-reply"></i></a>
                            <a href="#" class="renote-btn icon-btn" data-renote-id="${note.id}" title="リノート"><i class="fa-solid fa-retweet"></i></a>
                        ` : ''}
                        <a href="#" class="delete-btn icon-btn" data-delete-id="${note.id}" title="削除"><i class="fa-solid fa-trash-can"></i></a>
                    </div>
                </div>`;
            }).join('');
        };

        // --- フォームと返信のロジック ---
        const handlePostSubmit = (e) => {
            e.preventDefault();
            const noteText = new FormData(postForm).get('note');
            const replyTo = replyToInput.value;
            if (!noteText.trim()) return;

            const newNote = {
                id: crypto.randomUUID(), post: noteText, created_at: new Date().toISOString(),
                reply_to: replyTo || null, renote_from_id: null,
            };
            const notes = notesDB.get();
            notes.push(newNote);
            notesDB.save(notes);
            
            postForm.reset();
            cancelReply();
            renderTimeline();
        };

        const cancelReply = () => {
            replyToInput.value = '';
            replyInfo.textContent = '';
            cancelReplyBtn.style.display = 'none';
        };

        // イベント委譲：タイムライン上のクリック処理をまとめる
        timeline.addEventListener('click', (e) => {
            const target = e.target;
            const replyBtn = target.closest('.reply-btn');
            const renoteBtn = target.closest('.renote-btn');
            const deleteBtn = target.closest('.delete-btn');
            const tagLink = target.closest('.tag');

            // 返信ボタン
            if (replyBtn) {
                e.preventDefault();
                const replyToId = replyBtn.dataset.replyTo;
                const noteElement = document.getElementById(`note-${replyToId}`);
                const noteContent = noteElement.querySelector('.note-content').textContent.trim();
                replyToInput.value = replyToId;
                replyInfo.textContent = `返信先: ${noteContent.substring(0, 20)}...`;
                cancelReplyBtn.style.display = 'inline';
                postForm.querySelector('input[type="text"]').focus();
            } 
            // リノートボタン
            else if (renoteBtn) {
                e.preventDefault();
                if (!confirm('この投稿をリノートしますか？')) return;
                const renoteId = renoteBtn.dataset.renoteId;
                const renote = {
                    id: crypto.randomUUID(), post: null, created_at: new Date().toISOString(),
                    reply_to: null, renote_from_id: renoteId,
                };
                const notes = notesDB.get();
                notes.push(renote);
                notesDB.save(notes);
                renderTimeline();
            } 
            // 削除ボタン
            else if (deleteBtn) {
                e.preventDefault();
                if (!confirm('この投稿を本当に削除しますか？')) return;
                const deleteId = deleteBtn.dataset.deleteId;
                const notes = notesDB.get().filter(note => note.id !== deleteId);
                notesDB.save(notes);
                renderTimeline();
            } 
            // タグリンク
            else if (tagLink) {
                e.preventDefault();
                const tagName = tagLink.dataset.tag;
                renderTimeline(tagName);
            }
        });

        // --- イベントリスナーの設定 ---
        postForm.addEventListener('submit', handlePostSubmit);
        cancelReplyBtn.addEventListener('click', cancelReply);
        themeToggleBtn.addEventListener('click', () => theme.set(theme.get() === 'light' ? 'dark' : 'light'));

        // --- 初期化処理 ---
        theme.set(theme.get()); // 保存されたテーマを適用
        renderTimeline(); // タイムラインの初回描画
    });
    </script>
</body>
</html>
